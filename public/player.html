<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ò–≥—Ä–æ–∫ ‚Äî –ú–æ–Ω–æ–ø–æ–ª–∏—è realtime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/styles.css" rel="stylesheet" />
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>–ö–∞—Ä—Ç–æ—á–∫–∞ –∏–≥—Ä–æ–∫–∞</h1>
      <div id="joinBlock">
        <p class="small">–í–≤–µ–¥–∏—Ç–µ –∏–º—è, —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ.</p>
        <div class="row">
          <input id="playerName" placeholder="–í–∞—à–µ –∏–º—è" />
          <button id="joinBtn" class="btn-primary">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>
      </div>

      <div id="playerBlock" style="display:none;">
        <div class="row">
          <span class="badge" id="pName"></span>
          <span class="pill">ID: <span id="pId"></span></span>
        </div>

        <div class="kpi" style="margin: 12px 0;">
          <div class="pill">üí∞ –£.–ï.: <b id="pMoney">‚Äî</b></div>
          <div class="pill">ü§ù –î–æ–≤–µ—Ä–∏–µ: <b id="pTrust">‚Äî</b></div>
        </div>

        <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
        <div id="pHistory" class="list small"></div>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    const joinBlock   = document.getElementById("joinBlock");
    const playerBlock = document.getElementById("playerBlock");
    const nameInput   = document.getElementById("playerName");
    const joinBtn     = document.getElementById("joinBtn");

    const elName   = document.getElementById("pName");
    const elId     = document.getElementById("pId");
    const elMoney  = document.getElementById("pMoney");
    const elTrust  = document.getElementById("pTrust");
    const elHist   = document.getElementById("pHistory");

    let playerId = localStorage.getItem("playerId") || null;

    function renderHistory(history) {
      elHist.innerHTML = history
        .slice().reverse()
        .map(h => `<div>‚Ä¢ ${new Date(h.ts).toLocaleString()} ‚Äî ${h.note}</div>`)
        .join("");
    }

    function showPlayer(state) {
      elName.textContent = state.name;
      elId.textContent = state.id;
      elMoney.textContent = state.money;
      elTrust.textContent = state.trust;
      renderHistory(state.history);
      joinBlock.style.display = "none";
      playerBlock.style.display = "block";
    }

    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π playerId ‚Äî –ø—Ä–∏–≤—è–∂–µ–º—Å—è (–ø–æ—Å–ª–µ F5)
    socket.on("connect", () => {
      if (playerId) {
        socket.emit("player:bind", { playerId }, (res) => {
          if (!res?.ok) {
            // –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –æ—á–∏—Å—Ç–∏–º –∏ –ø–æ–ø—Ä–æ—Å–∏–º –∑–∞–Ω–æ–≤–æ
            localStorage.removeItem("playerId");
            playerId = null;
          }
        });
      }
    });

    // –†–µ–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä–æ–∫–∞
    socket.on("player:state", (state) => {
      playerId = state.id;
      localStorage.setItem("playerId", playerId);
      showPlayer(state);
    });

    joinBtn.addEventListener("click", () => {
      const name = nameInput.value.trim();
      if (!name) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è");
        return;
      }
      socket.emit("player:join", { name }, (res) => {
        if (!res?.ok) {
          alert(res?.error || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è");
          return;
        }
        playerId = res.playerId;
        localStorage.setItem("playerId", playerId);
      });
    });
  </script>
</body>
</html>
