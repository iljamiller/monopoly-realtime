<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–í–µ–¥—É—â–∏–π ‚Äî –ú–æ–Ω–æ–ø–æ–ª–∏—è realtime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/styles.css" rel="stylesheet" />
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>–ü–∞–Ω–µ–ª—å –≤–µ–¥—É—â–µ–≥–æ</h1>

      <div class="grid grid-2">
        <div>
          <h2>–ò–≥—Ä–æ–∫–∏</h2>
          <div id="playersList" class="list"></div>
        </div>

        <div>
          <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
          <div class="row">
            <select id="playerSelect"></select>
          </div>
          <hr />
          <div class="row">
            <input id="moneyDelta" type="number" placeholder="Œî —É.–µ. (–Ω–∞–ø—Ä–∏–º–µ—Ä 100 –∏–ª–∏ -50)" />
            <input id="trustDelta" type="number" placeholder="Œî –¥–æ–≤–µ—Ä–∏—è (–Ω–∞–ø—Ä. 10 –∏–ª–∏ -5)" />
          </div>
          <div class="row">
            <input id="note" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="flex:1" />
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="applyBtn" class="btn-accent">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <button id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å –ø–æ–ª—è</button>
            <button id="removeBtn" class="btn-danger" title="–£–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞ (–∏–∑ —Å–µ—Å—Å–∏–∏)">–£–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const socket = io();

    const playersList = document.getElementById("playersList");
    const select      = document.getElementById("playerSelect");
    const moneyDelta  = document.getElementById("moneyDelta");
    const trustDelta  = document.getElementById("trustDelta");
    const note        = document.getElementById("note");
    const applyBtn    = document.getElementById("applyBtn");
    const resetBtn    = document.getElementById("resetBtn");
    const removeBtn   = document.getElementById("removeBtn");

    // –í–µ–¥—É—â–∏–π –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
    socket.emit("host:join");

    function renderPlayers(list) {
      // –ó–∞–ø–æ–ª–Ω–∏–º —Å–µ–ª–µ–∫—Ç
      select.innerHTML = "";
      list.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id; opt.textContent = `${p.name} ‚Äî ${p.money} —É.–µ., –¥–æ–≤–µ—Ä–∏–µ ${p.trust}`;
        select.appendChild(opt);
      });

      // –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ —Å –º–∏–Ω–∏-–∏—Å—Ç–æ—Ä–∏–µ–π
      playersList.innerHTML = list.map(p => `
        <div class="card" style="padding:12px; margin-bottom:8px;">
          <div class="row">
            <div class="badge">${p.name}</div>
            <div class="pill">ID: ${p.id}</div>
          </div>
          <div class="kpi" style="margin-top:8px;">
            <div class="pill">üí∞ ${p.money} —É.–µ.</div>
            <div class="pill">ü§ù ${p.trust} –¥–æ–≤–µ—Ä–∏—è</div>
          </div>
          <div class="small" style="margin-top:8px;">
            <b>–ò—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ):</b>
            <div>
              ${p.history.map(h => `‚Ä¢ ${new Date(h.ts).toLocaleString()} ‚Äî ${h.note}`).join("<br/>")}
            </div>
          </div>
        </div>
      `).join("");
    }

    socket.on("players:list", renderPlayers);

    applyBtn.addEventListener("click", () => {
      const playerId = select.value;
      if (!playerId) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞");
      const m = Number(moneyDelta.value || 0);
      const t = Number(trustDelta.value || 0);
      const n = note.value.trim();

      socket.emit("host:adjust", {
        playerId, moneyDelta: m, trustDelta: t, note: n
      }, (res) => {
        if (!res?.ok) alert(res?.error || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è");
        else resetFields(false);
      });
    });

    removeBtn.addEventListener("click", () => {
      const playerId = select.value;
      if (!playerId) return alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞");
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞ –∏–∑ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏?")) return;
      socket.emit("host:removePlayer", { playerId }, (res) => {
        if (!res?.ok) alert(res?.error || "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞");
      });
    });

    function resetFields(clearSelect = false) {
      moneyDelta.value = "";
      trustDelta.value = "";
      note.value = "";
      if (clearSelect) select.selectedIndex = -1;
    }
    resetBtn.addEventListener("click", () => resetFields());
  </script>
</body>
</html>
